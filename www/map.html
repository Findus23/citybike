<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>CityBikes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-rc.1/leaflet.css"/>
    <style>
        body {
            margin: 0;
        }

        html, body, #map {
            height: 100%;
        }
    </style>

</head>
<body>
<div id="map"></div>
</body>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-rc.1/leaflet.js"></script>
<script>

    var map = L.map('map').setView([48.51579416571888, 15.6255304813385], 16);
    var layer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    });
    var emptyLayer = L.tileLayer("").addTo(map);

    var citybikeIcon = L.Icon.extend({
        options: {
            iconUrl: "citybike.png",
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        }
    });
    var altCitybikeIcon = citybikeIcon.extend({
        options: {
            iconUrl: "citybikeAlt.png"
        }
    });


    $.ajax({
        dataType: "json",
        url: "test.json",
        success: function (data) {
            lines.addData(data);
            lines.addTo(map);
        }
    });
    var stations = {};

    var stationLayer = L.geoJson(null, {
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: new citybikeIcon()});
        },
        onEachFeature: function (feature, layer) {
//            layer._leaflet_id = feature.properties.ref;
//            console.log(feature.properties.ref);
//            console.log(feature.properties);
            stations[feature.properties.ref] = feature.properties.name;
            layer.bindPopup(feature.properties.name);
            layer._leaflet_id = 10000 + feature.properties.ref;
        }
    });

    $.ajax({
        dataType: "json",
        url: "stations.json",
        success: function (data) {
            stationLayer.addData(data);
            stationLayer.addTo(map);
            map.fitBounds(stationLayer.getBounds());
        }
    });

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: function (e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 10,
                    color: '#666'
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }
                stationLayer.getLayer(10000 + layer.nodes[0]).setIcon(new altCitybikeIcon());
                stationLayer.getLayer(10000 + layer.nodes[1]).setIcon(new altCitybikeIcon());
            },
            mouseout: function (e) {
                lines.resetStyle(e.target);
                stationLayer.getLayer(10000 + layer.nodes[0]).setIcon(new citybikeIcon());
                stationLayer.getLayer(10000 + layer.nodes[1]).setIcon(new citybikeIcon());

            }
        });

    }


    var lines = L.geoJson(null, {
        onEachFeature: function (feature, layer) {
            layer.bindPopup(stations[feature.properties.nodes[0]] + " - " + stations[feature.properties.nodes[1]]);
            onEachFeature(feature, layer);
            layer.nodes = feature.properties.nodes;
//            layer._leaflet_id = feature.properties.id;

        },
        style: {
            weight: 5
        }
    });


    var mapLayers = {
        'Standard': layer,
        "Leer": emptyLayer
    };
    var overlays = {
        "Wege": lines,
        "Stationen": stationLayer
    };
    var control = L.control.layers(mapLayers, overlays, {collapsed: false}).addTo(map);


</script>
</html>